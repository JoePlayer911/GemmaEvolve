# Fix: Database Race Condition & Cross-Island Sampling (2026-01-11)

## Summary
Resolved a critical race condition and logic error in `ProgramDatabase` that caused tests to fail with "Requested island X but got program from island Y". This update ensures strict island isolation during sampling and adds thread safety for concurrent execution.

## Changes

### `openevolve/database.py`

*   **Fixed Cross-Island Sampling Bug**:
    *   Modified `_sample_from_archive_for_island`: Previously, if the archive contained no programs from the requested island, it would fall back to returning *any* random program from the archive. This violated island isolation principles.
    *   The fix changes the fallback behavior to use `_sample_from_island_weighted(island_id)` instead, ensuring a program from the correct island is always returned (or proper empty-island handling is triggered).

*   **Added Thread Safety**:
    *   Added `threading.RLock` to `ProgramDatabase`.
    *   Wrapped the critical section in `sample_from_island` with `with self.lock:` to prevent race conditions when multiple workers access the database concurrently.

## Impact
*   `test_sample_from_island_ratios.TestSampleFromIslandRatios` passes reliably.
*   Parallel evolution with multiple islands will now strictly respect island boundaries during sampling, preventing "genetic pollution" across islands unless explicitly migrated.
*   Eliminated "Race condition detected" errors in test logs.

### `openevolve/process_parallel.py` & `openevolve/database.py` (Follow-up Fix)
*   **Fixed `list index out of range` in Worker Process**:
    *   Added validation in `ProgramDatabase.load()` to ensure `current_island` loaded from metadata conforms to the current `num_islands` configuration.
    *   **Fixed `island_feature_maps` sizing**: Added logic in `load()` to ensure `island_feature_maps` is resized to match the number of islands. This prevents `IndexError` in the controller when processing results for islands that exist in metadata but were missing from the feature map list.
    *   Added defensive bounds checking in `process_parallel.py` to gracefully handle and correct any out-of-bounds `parent_island` indices during worker initialization, preventing worker crashes.
